[phases.setup]
nixPkgs = ['nodejs-18_x', 'python311']

[phases.install]
cmds = [
    'python --version',
    'node --version',
    'npm --version',
    'pip install -r requirements.txt',
    'echo "=== INSTALLING FRONTEND DEPENDENCIES ==="',
    'cd frontend && npm install --verbose'
]

[phases.build]
cmds = [
    'echo "=== BUILDING REACT APPLICATION ==="',
    'cd frontend && pwd && ls -la',
    'cd frontend && NODE_ENV=production npm run build',
    'echo "=== CHECKING BUILD OUTPUT ==="',
    'ls -la frontend/dist/ || echo "No dist directory found"',
    'echo "=== COPYING REACT BUILD TO BACKEND ==="',
    'mkdir -p backend/static',
    'rm -rf backend/static/*',
    'cp -r frontend/dist/* backend/static/',
    'echo "=== VERIFYING COPIED FILES ==="',
    'ls -la backend/static/',
    'echo "=== FINAL VERIFICATION ==="',
    'if [ -f "backend/static/index.html" ]; then echo "✅ SUCCESS: React build copied successfully"; else echo "❌ ERROR: React index.html missing"; exit 1; fi'
]

[phases.start]
cmd = 'cd backend && gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --timeout 60'

[variables]
NODE_ENV = 'production'
FLASK_ENV = 'production'
RAILWAY_ENVIRONMENT = 'true'